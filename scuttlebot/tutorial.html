<html>
    <head>
    <title>Tutorial - Scuttlebot - SSBC</title>
    <link rel="stylesheet" href="/normalize.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/atelier-forest-light.css">
    <script src="/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
    <body>
      <div id="topnav">
    <div id="topnav-inner">
      <a class="topnav-item " href="/" title="Home">
      Home<br><small>SSBC</small>
    </a>
      <a class="topnav-item " href="/patchwork" title="Patchwork">
      Patchwork<br><small>Social App</small>
    </a>
      <a class="topnav-item selected" href="/scuttlebot" title="Scuttlebot">
      Scuttlebot<br><small>P2P Log Store</small>
    </a>
      <a class="topnav-item " href="/docs" title="Documentation">
      Documentation<br><small>APIs, Articles</small>
    </a>
    </div>
  </div>
      <div id="layout">
        <div id="leftnav">
      <div class="leftnav-item ">
      <a href="/scuttlebot" title="Scuttlebot">Scuttlebot</a>
    </div>
      <div class="leftnav-subitems">
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/install.html" title="Install">Install</a>
    </div>
        <div class="leftnav-item selected">
      <a href="/docs/scuttlebot/tutorial.html" title="Tutorial">Tutorial</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/api/scuttlebot.html" title="API / CLI Reference">API / CLI Reference</a>
    </div>
      </div>
      <div class="leftnav-item">Examples</div>
      <div class="leftnav-subitems">
        <div class="leftnav-item ">
      <a href="/ssb-blessed-dashboard" title="Blessed Dashboard">Blessed Dashboard</a>
    </div>
        <div class="leftnav-item ">
      <a href="/ssb-example-whois" title="Example "Whois"">Example "Whois"</a>
    </div>
        <div class="leftnav-item ">
      <a href="/ssb-example-pm" title="Private Message">Private Message</a>
    </div>
      </div>
      <div class="leftnav-item">Key Concepts</div>
      <div class="leftnav-subitems">
        <div class="leftnav-item ">
      <a href="/secure-scuttlebutt" title="Secure Scuttlebutt: a global database protocol">Secure Scuttlebutt: a global database protocol</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/ssb/linking.html" title="Content-Hash Linking">Content-Hash Linking</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/ssb/secret-handshake.html" title="Secret Handshake: a secure channel protocol">Secret Handshake: a secure channel protocol</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/ssb/end-to-end-encryption.html" title="Private Box: metadata-free encryption">Private Box: metadata-free encryption</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/ssb/faq.html" title="Frequently Asked Questions">Frequently Asked Questions</a>
    </div>
      </div>
      <div class="leftnav-item">Howto Guides</div>
      <div class="leftnav-subitems">
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-setup-a-pub.html" title="Setup a Pub">Setup a Pub</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-create-a-js-client.html" title="Create a JS Client">Create a JS Client</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-get-your-id.html" title="Get your ID">Get your ID</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-get-your-address.html" title="Get your Address">Get your Address</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-publish-a-post.html" title="Publish a Post">Publish a Post</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-publish-a-file.html" title="Publish a File">Publish a File</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-publish-encrypted-messages.html" title="Publish Encrypted Messages">Publish Encrypted Messages</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-follow-unfollow.html" title="Follow/Unfollow">Follow/Unfollow</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-announce-a-pub-server.html" title="Announce a Pub Server">Announce a Pub Server</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-create-an-invite.html" title="Create an Invite">Create an Invite</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-use-an-invite.html" title="Use an Invite">Use an Invite</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/scuttlebot/howto-update-your-profile.html" title="Update your Profile">Update your Profile</a>
    </div>
      </div>
    </div>
        <div id="content">
          <h1 id="introduction-to-using-scuttlebot">Introduction to Using Scuttlebot</h1>
<p>This tutorial will help you familiarize with Scuttlebot, so you can build scripts and applications.</p>
<p>Scuttlebot is pretty unusual compared to datastores like MySQL or Redis, so let&#39;s get started with some basics.</p>
<h2 id="what-is-scuttlebot-">What is Scuttlebot?</h2>
<p>Scuttlebot is a peer-to-peer log store.
Its data model is similar to that of <a href="https://kafka.apache.org/">Apache Kafka</a>, and it&#39;s part of a pattern that&#39;s now referred to as the <a href="kappa-architecture.com/">Kappa Architecture</a>.</p>
<p>What is Kappa Architecture?</p>
<blockquote>
<p>Kappa Architecture is a software architecture pattern.
 Rather than using a relational DB like SQL or a key-value store like Cassandra, the canonical data store in a Kappa Architecture system is an append-only immutable log.
 From the log, data is streamed through a computational system and fed into auxiliary stores for serving.</p>
</blockquote>
<p>So, imagine if Twitter supported JSON posts, and allowed more characters.
Now imagine your JSON-Twitter was also peer-to-peer.</p>
<p>In a nutshell, that&#39;s Scuttlebot.</p>
<h2 id="how-do-you-write-applications-with-it-">How do you write applications with it?</h2>
<p>While feeds of JSON messages may seem pretty limited, they&#39;re actually able to support some pretty complex data-structures.</p>
<p>For instance, imagine we wanted to write a new file-sharing app.
To declare a new &quot;package&quot; of files, we might just publish a message like this:</p>
<pre><code class="lang-js">{
  type: &#39;create-file-package&#39;,
  package: &#39;My Files Package&#39;
}
</code></pre>
<p>Then, we could add files with some more messages:</p>
<pre><code class="lang-js">{
  type: &#39;add-file-to-package&#39;,
  package: &#39;My Files Package&#39;,
  name: &#39;hello-world.txt&#39;,
  fileData: &#39;Hello, world!&#39;
}
{
  type: &#39;add-file-to-package&#39;,
  package: &#39;My Files Package&#39;,
  name: &#39;my-picture.jpg&#39;,
  fileData: fs.readFileSync(&#39;./my-picture.jpg&#39;).toString(&#39;base64&#39;)
}
</code></pre>
<p>And then decide that, no, maybe that picture shouldnt be in the package:</p>
<pre><code class="lang-js">{
  type: &#39;remove-file-from-package&#39;,
  package: &#39;My Files Package&#39;,
  name: &#39;my-picture.jpg&#39;
}
</code></pre>
<p>With the right processing code, we could easily scan these messages and produce a predictable output state, in the form of a data-structure:</p>
<pre><code class="lang-js">{
  package: &#39;My Files Package&#39;,
  files: { &#39;hello-world.txt&#39;: &#39;Hello, world!&#39; }
}
</code></pre>
<p>And that&#39;s exactly how Scuttlebot applications work.
So, let&#39;s dig into the practical steps of making that happen.</p>
<h2 id="setup-the-server">Setup the Server</h2>
<p>The first step is to <a href="./install.html">install</a> Scuttlebot.
You&#39;ll want the server running on the device that&#39;s running your application.</p>
<p>Scuttlebot is meant to be used on users&#39; devices, in a P2P network.
It can be embedded (<a href="https://ssbc.github.io/patchwork/">Patchwork</a> does this) but that&#39;s going to create conflicts after the user installs two Scuttlebot-embedding apps.
So, for now, it&#39;s best to tell your users to install and run Scuttlebot or Patchwork themselves, as dependencies to your app.</p>
<h2 id="create-the-client">Create the Client</h2>
<p>The current process for connecting to scuttlebot involves loading the master keypair from sbot&#39;s config (~/.ssb/secret).
You can do this automatically with the <a href="https://github.com/ssbc/ssb-client">ssb-client</a> module.</p>
<pre><code class="lang-js">var ssbClient = require(&#39;ssb-client&#39;)
ssbClient(function (err, sbot) {
  // ready
})
</code></pre>
<p>NOTE: Scuttlebot&#39;s CLI translates directly from the shell to RPC calls.
That means any call you can make programmatically can be made from the shell as well.</p>
<h2 id="publishing-messages">Publishing Messages</h2>
<p>Publishing messages in Scuttlebot is very simple:</p>
<pre><code class="lang-js">sbot.publish({ type: type, ... }, cb)
</code></pre>
<p>Here&#39;s an example publish:</p>
<pre><code class="lang-js">sbot.publish({ type: &#39;post&#39;, text: &#39;hello, world&#39; }, cb)
</code></pre>
<p>You are free to put anything you want in the message, with the following rules:</p>
<ul>
<li>You must include a <code>type</code> attribute.</li>
<li>The output message, including headers, cannot exceed 8kb.</li>
</ul>
<p>You can find <a href="https://github.com/ssbc/ssb-msg-schemas">common message-schemas here</a>.
For our toy file-publishing app, we&#39;ll make our own message schemas.</p>
<p>Let&#39;s create some convenience functions to do the publishing:</p>
<pre><code class="lang-js">function createPackage (sbot, package, cb) {
  sbot.publish({
    type: &#39;create-file-package&#39;,
    package: package
  }, cb)
}

function addFile (sbot, package, name, fileData, cb) {
  sbot.publish({
    type: &#39;add-file-to-package&#39;,
    package: package,
    name: name,
    fileData: fileData
  }, cb)
}

function removeFile (sbot, package, name, cb) {
  sbot.publish({
    type: &#39;remove-file-from-package&#39;,
    package: package,
    name: name
  }, cb)
}
</code></pre>
<p>Now it&#39;s a little easier to create the messages we published earlier:</p>
<pre><code class="lang-js">var pictureBase64 = fs.readFileSync(&#39;./my-picture.jpg&#39;).toString(&#39;base64&#39;)
createPackage(sbot, &#39;My Files Package&#39;)
addFile(sbot, &#39;My Files Package&#39;, &#39;hello-world.txt&#39;, &#39;Hello, world!&#39;)
addFile(sbot, &#39;My Files Package&#39;, &#39;my-picture.jpg&#39;, pictureBase64)
removeFile(sbot, &#39;My Files Package&#39;, &#39;my-picture.jpg&#39;)
</code></pre>
<h2 id="attaching-files-to-messages">Attaching Files to Messages</h2>
<p>Messages have an 8kb limit, including the headers that are automatically added, so it&#39;s not a good idea to try to cram base64-encoded files into them.
Instead, we should use Scuttlebot&#39;s blob-store to publish the files, which presently has a 5MB limit.</p>
<p>We&#39;ll add another function to do this:</p>
<pre><code class="lang-js">var fs = require(&#39;fs&#39;)
var pull = require(&#39;pull-stream&#39;) // will explain later
var toPull = require(&#39;stream-to-pull-stream&#39;)

function addFileFromDisk (sbot, package, name, filePath, cb) {
  // add the file to the local blobstore
  pull(
    toPull.source(fs.createReadStream(filePath)),
    sbot.blobs.add(function (err, fileId) {
      if (err)
        cb(err)
      else {
        // publish
        addFile(sbot, package, name, fileId, cb)
      }
    })
  )
}
</code></pre>
<p>And we can now use this function to publish our jpg:</p>
<pre><code class="lang-js">addFileFromDisk(sbot, &#39;My Files Package&#39;, &#39;my-picture.jpg&#39;, &#39;./my-picture.jpg&#39;)
</code></pre>
<p>The result is something more like this:</p>
<pre><code class="lang-js">{
  type: &#39;add-file-to-package&#39;,
  package: &#39;My Files Package&#39;,
  name: &#39;my-picture.jpg&#39;,
  fileData: &#39;&amp;RRELXJAxum631eq1ikj7+qngd3f6Dvz7eA1mZNHBPQ0=.sha256&#39;
}
</code></pre>
<p>The value of <code>fileData</code> is now a <a href="https://ssbc.github.io/docs/ssb/linking.html">content-hash link</a>.
When other Scuttlebots see it, they&#39;ll ask their peers for the blob that matches that sha256 hash.
That means the file will lag behind the message a little bit, but it&#39;ll get there eventually!</p>
<h2 id="reading-the-messages">Reading the Messages</h2>
<p>Now that we&#39;ve got the publishing handled, we need to read the messages in, and process them into our output state.</p>
<p>Scuttlebot uses <a href="https://github.com/dominictarr/pull-stream">pull-streams</a>.
In most cases, you&#39;ll use them like this:   </p>
<pre><code class="lang-js">pull(sbot.foo(), pull.drain(function (msg) {
  // process the message as it arrive
}, function (err) {
  // stream is over
}))
</code></pre>
<p>Or, like this</p>
<pre><code class="lang-js">pull(sbot.foo(), pull.collect(function (err, msgs) {
  // process all the messages after the stream ends
}))
</code></pre>
<p>We&#39;ll use them now with <a href="http://ssbc.github.io/docs/api/scuttlebot.html#createlogstream-source">createLogStream</a> to create a persistent live stream of messages.
As each message is added, either due to network-gossip, or by the local user, it will be emitted here:</p>
<pre><code class="lang-js">pull(sbot.createLogStream({ live: true }), pull.drain(processMsg))
</code></pre>
<h2 id="processing-the-messages">Processing the Messages</h2>
<p>Let&#39;s create some in-memory data structures to hold onto the file-packages.</p>
<p>It&#39;s important to realize, that the order of messages is only preserved within a given user&#39;s feed.
If Bob publishes 3 messages in a row, then every user that syncs Bob&#39;s feed will get those 3 messages in the same order.
But, if Alice publishes a fourth message, other users will not know if her message came before Bob&#39;s 3 messages, after them, or somewhere in the middle.</p>
<p>This can be mitigated with <a href="https://ssbc.github.io/docs/ssb/linking.html">Content Hash Links</a>, which provides a guaranteed &quot;happens before&quot; relationship.
However, that&#39;s not enough in our case to allow us to mix the users&#39; packages.
Therefore, we&#39;ll separate the packages by user.</p>
<p>Here&#39;s how we&#39;ll handle <code>create-file-package</code> messages:</p>
<pre><code class="lang-js">var packagesByUser = {}

function onCreatePackage (msg) {
  // pull variables out of the message
  var author = msg.value.author
  var package = msg.value.content.package

  // validate the content
  if (!package || typeof package !== &#39;string&#39;)
    return console.log(&#39;Warning: malformed message&#39;, msg)

  // create the user&#39;s entry in the listing, if it does not exist yet
  if (!(author in packagesByUser))
    packagesByUser[author] = {}

  // create the package structure (overwrite if it already existed)
  packagesByUser[author][package] = {
    package: package,
    files: {}
  }
}
</code></pre>
<p>Notice that <code>msg.value.content.package</code> is validated, but <code>msg.value.author</code> is not.
Scuttlebot&#39;s internal APIs will validate everything in <code>msg.value.*</code> except for <code>msg.value.content.*</code>.
That&#39;s up to the application.</p>
<p>Like incoming HTTP requests, you should always validate the content of the message, as it may be incorrect or harmful.</p>
<p>Let&#39;s handle the &#39;add-file-to-package&#39; message next:</p>
<pre><code class="lang-js">function onAddFile (msg) {
  // pull variables out of the message
  var author = msg.value.author
  var package = msg.value.content.package
  var name = msg.value.content.name
  var fileData = msg.value.content.fileData

  // validate the content
  if (!package || typeof package !== &#39;string&#39;)
    return console.log(&#39;Warning: malformed message&#39;, msg)
  if (!name || typeof name !== &#39;string&#39;)
    return console.log(&#39;Warning: malformed message&#39;, msg)
  if (!fileData || typeof fileData !== &#39;string&#39;)
    return console.log(&#39;Warning: malformed message&#39;, msg)

  // reject if the package doesnt exist yet
  if (!(author in packagesByUser) || !(package in packagesByUser[author]))
    return console.log(&#39;Warning: add-file-to-package message published before create-package&#39;, msg)

  // update the file entry
  packagesByUser[author][package].files[name] = fileData
}
</code></pre>
<p>That should be relatively unsurprising.
The remove-file code should also be pretty obvious:</p>
<pre><code class="lang-js">function onRemoveFile (msg) {
  // pull variables out of the message
  var author = msg.value.author
  var package = msg.value.content.package
  var name = msg.value.content.name

  // validate the content
  if (!package || typeof package !== &#39;string&#39;)
    return console.log(&#39;Warning: malformed message&#39;, msg)
  if (!name || typeof name !== &#39;string&#39;)
    return console.log(&#39;Warning: malformed message&#39;, msg)

  // reject if the package doesnt exist yet
  if (!(author in packagesByUser) || !(package in packagesByUser[author]))
    return console.log(&#39;Warning: add-file-to-package message published before create-package&#39;, msg)

  // remove the file entry
  delete packagesByUser[author][package].files[name]
}
</code></pre>
<p>Now we can tie it together with the processMsg function:</p>
<pre><code class="lang-js">pull(sbot.createLogStream({ live: true }), pull.drain(processMsg))

function processMsg (msg) {
  if (msg.value.content.type == &#39;create-package&#39;)
    onCreatePackage(msg)

  if (msg.value.content.type == &#39;add-file-to-package&#39;)
    onAddFile(msg)

  if (msg.value.content.type == &#39;remove-file-from-package&#39;)
    onRemoveFile(msg)
}
</code></pre>
<p>And, there you have it.
Our data-structure will now look like what we expect it to:</p>
<pre><code class="lang-js">// after processing the messages
console.log(packagesByUser) /* =&gt; {
  &#39;@hxGxqPrplLjRG2vtjQL87abX4QKqeLgCwQpS730nNwE=.ed25519&#39;: {
    &#39;My Files Package&#39;: {
      package: &#39;My Files Package&#39;,
      files: { &#39;hello-world.txt&#39;: &#39;Hello, world!&#39; }
    }
  }
}
</code></pre>
<p>But, what about those files in the blob-store?</p>
<h2 id="reading-files-from-messages">Reading Files from Messages</h2>
<p>The blob-store provides a hash-id when you add a file, which is used to create <a href="https://ssbc.github.io/docs/ssb/linking.html">Content-Hash Links</a>.</p>
<p>When you expect an attribute to be a link, you can handle it with <a href="http://ssbc.github.io/docs/api/ssb-msgs.html">ssb-msgs</a> link functions.
Let&#39;s create a &quot;get file&quot; function to demonstrate it:</p>
<pre><code class="lang-js">var fs = require(&#39;fs&#39;)
var mlib = require(&#39;ssb-msgs&#39;)
var pull = require(&#39;pull-stream&#39;)
var toPull = require(&#39;stream-to-pull-stream&#39;)

function writeFile (sbot, user, package, name, outPath) {
  // find the file
  if (!(user in packagesByUser))
    return cb(new Error(&#39;not found&#39;))
  if (!(package in packagesByUser[user]))
    return cb(new Error(&#39;not found&#39;))
  if (!(name in packagesByUser[user][package].files))
    return cb(new Error(&#39;not found&#39;))

  // handle depending on whether it&#39;s a link
  var fileData = packagesByUser[user][package].files[name]
  if (mlib.isLink(fileData, &#39;blob&#39;)) {
    // it is, pull from the blob store
    readFileFromBlobstore(sbot, fileData, outPath, cb)
  } else {
    // it&#39;s not, the data was inlined in the message
    fs.writeFile(outPath, fileData, cb)
  }
}
function readFileFromBlobstore (sbot, fileData, outPath, cb) {
  // standardize the link format (links can take many different shapes)
  var fileLink = mlib.link(fileData)

  // get from blobstore and write to disk
  pull(
    sbot.blobs.get(fileLink.link),
    toPull.sink(fs.createWriteStream(outpath), cb)
  )
}
</code></pre>
<p>And there you have it!
A nice quick way to get your jpg:</p>
<pre><code class="lang-js">writeFile(sbot, userId, &#39;My Files Package&#39;, &#39;my-picture.jpg&#39;, &#39;./my-picture.jpg&#39;, console.log)
</code></pre>
<h2 id="next-steps">Next Steps</h2>
<p>From here, you should read about the <a href="https://ssbc.github.io/secure-scuttlebutt/">Secure Scuttlebutt protocol</a>, and be sure to understand the <a href="https://ssbc.github.io/docs/ssb/linking.html">Content-Hash Linking</a>.
There are Howto Guides and Examples along the left nav.
You can also find detailed API references, and some articles, in the <a href="https://ssbc.github.io/docs/">documentation section</a>.</p>
<p>Happy coding!</p>

        </div>
      </div>
    </body>
  </html>